<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Fleet Management</title>
    
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Material Design Components -->
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="mdc-typography">
    <!-- Top App Bar -->
    <header class="mdc-top-app-bar mdc-top-app-bar--fixed">
        <div class="mdc-top-app-bar__row">
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                <button class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button" 
                        aria-label="Open navigation menu" id="menu-toggle">
                    menu
                </button>
                <span class="mdc-top-app-bar__title">
                    <i class="material-icons" style="margin-right: 8px;">directions_car</i>
                    AI Fleet Management
                </span>
            </section>
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
                <!-- Notifications -->
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" 
                        aria-label="Notifications" id="notifications-btn">
                    notifications
                </button>
                
                <!-- User Menu -->
                <div class="mdc-menu-surface--anchor">
                    <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" 
                            aria-label="User menu" id="user-menu-btn">
                        account_circle
                    </button>
                    <div class="mdc-menu mdc-menu-surface" id="user-menu">
                        <ul class="mdc-list" role="menu" aria-hidden="true" aria-orientation="vertical" tabindex="-1">
                            <li class="mdc-list-item" role="menuitem">
                                <span class="mdc-list-item__ripple"></span>
                                <span class="mdc-list-item__text">Profile</span>
                            </li>
                            <li class="mdc-list-item" role="menuitem">
                                <span class="mdc-list-item__ripple"></span>
                                <span class="mdc-list-item__text">Settings</span>
                            </li>
                            <li class="mdc-list-divider" role="separator"></li>
                            <li class="mdc-list-item" role="menuitem">
                                <span class="mdc-list-item__ripple"></span>
                                <span class="mdc-list-item__text">
                                    <a href="/auth/logout" style="text-decoration: none; color: inherit;">Logout</a>
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>
    </header>

    <!-- Navigation Drawer -->
    <aside class="mdc-drawer mdc-drawer--dismissible mdc-top-app-bar--fixed-adjust" id="navigation-drawer">
        <div class="mdc-drawer__header">
            <h3 class="mdc-drawer__title">Navigation</h3>
            <h6 class="mdc-drawer__subtitle">
                <% if (typeof user !== 'undefined' && user) { %>
                    Welcome, <%= user.username %>
                <% } %>
            </h6>
        </div>
        <div class="mdc-drawer__content">
            <nav class="mdc-list">
                <a class="mdc-list-item mdc-list-item--activated" href="/dashboard" aria-current="page">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">dashboard</i>
                    <span class="mdc-list-item__text">Dashboard</span>
                </a>
                <a class="mdc-list-item" href="/vehicles">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">directions_car</i>
                    <span class="mdc-list-item__text">Vehicles</span>
                </a>
                <a class="mdc-list-item" href="/routes">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">map</i>
                    <span class="mdc-list-item__text">Routes</span>
                </a>
                <a class="mdc-list-item" href="/trips">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">navigation</i>
                    <span class="mdc-list-item__text">Trips</span>
                </a>
                <a class="mdc-list-item" href="/maintenance">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">build</i>
                    <span class="mdc-list-item__text">Maintenance</span>
                </a>
                <a class="mdc-list-item" href="/drivers">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">person</i>
                    <span class="mdc-list-item__text">Drivers</span>
                </a>
                <a class="mdc-list-item" href="/analytics">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">analytics</i>
                    <span class="mdc-list-item__text">Analytics</span>
                </a>
                
                <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
                    <hr class="mdc-list-divider">
                    <h6 class="mdc-list-group__subheader">Admin</h6>
                    <a class="mdc-list-item" href="/admin/dashboard">
                        <span class="mdc-list-item__ripple"></span>
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">admin_panel_settings</i>
                        <span class="mdc-list-item__text">Admin Dashboard</span>
                    </a>
                    <a class="mdc-list-item" href="/admin/users">
                        <span class="mdc-list-item__ripple"></span>
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">people</i>
                        <span class="mdc-list-item__text">Users</span>
                    </a>
                <% } %>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <div class="mdc-top-app-bar--fixed-adjust">
            <!-- Flash Messages -->
            <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
                <div class="mdc-snackbar" id="success-snackbar">
                    <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
                        <div class="mdc-snackbar__label" aria-atomic="false">
                            <%= success_msg %>
                        </div>
                        <div class="mdc-snackbar__actions" aria-atomic="true">
                            <button type="button" class="mdc-button mdc-snackbar__action">
                                <div class="mdc-button__ripple"></div>
                                <span class="mdc-button__label">Dismiss</span>
                            </button>
                        </div>
                    </div>
                </div>
            <% } %>

            <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
                <div class="mdc-snackbar" id="error-snackbar">
                    <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
                        <div class="mdc-snackbar__label" aria-atomic="false">
                            <%= error_msg %>
                        </div>
                        <div class="mdc-snackbar__actions" aria-atomic="true">
                            <button type="button" class="mdc-button mdc-snackbar__action">
                                <div class="mdc-button__ripple"></div>
                                <span class="mdc-button__label">Dismiss</span>
                            </button>
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Page Content -->
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="material-icons">dashboard</i>
                        Fleet Dashboard
                    </h1>
                    <p class="page-subtitle">Real-time fleet monitoring and analytics</p>
                </div>

                <!-- Stats Overview -->
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card__icon stat-card__icon--primary">
                            <i class="material-icons">directions_car</i>
                        </div>
                        <div class="stat-card__content">
                            <div class="stat-card__value" id="total-vehicles">-</div>
                            <div class="stat-card__label">Total Vehicles</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card__icon stat-card__icon--success">
                            <i class="material-icons">check_circle</i>
                        </div>
                        <div class="stat-card__content">
                            <div class="stat-card__value" id="active-vehicles">-</div>
                            <div class="stat-card__label">Active Vehicles</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card__icon stat-card__icon--warning">
                            <i class="material-icons">build</i>
                        </div>
                        <div class="stat-card__content">
                            <div class="stat-card__value" id="maintenance-alerts">-</div>
                            <div class="stat-card__label">Maintenance Alerts</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card__icon stat-card__icon--info">
                            <i class="material-icons">navigation</i>
                        </div>
                        <div class="stat-card__content">
                            <div class="stat-card__value" id="active-trips">-</div>
                            <div class="stat-card__label">Active Trips</div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- Fleet Health Overview -->
                    <div class="dashboard-card">
                        <div class="dashboard-card__header">
                            <div class="dashboard-card__title">
                                <i class="material-icons dashboard-card__icon dashboard-card__icon--primary">health_and_safety</i>
                                Fleet Health
                            </div>
                        </div>
                        <div class="dashboard-card__content">
                            <div class="health-score">
                                <div class="health-score__value" id="fleet-health-score">-</div>
                                <div class="health-score__label">Overall Health Score</div>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill progress-fill--success" id="health-progress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fuel Consumption -->
                    <div class="dashboard-card">
                        <div class="dashboard-card__header">
                            <div class="dashboard-card__title">
                                <i class="material-icons dashboard-card__icon dashboard-card__icon--warning">local_gas_station</i>
                                Fuel Consumption
                            </div>
                        </div>
                        <div class="dashboard-card__content">
                            <div class="fuel-stats">
                                <div class="fuel-stat">
                                    <span class="fuel-stat__label">Total Consumed:</span>
                                    <span class="fuel-stat__value" id="total-fuel">-</span>
                                </div>
                                <div class="fuel-stat">
                                    <span class="fuel-stat__label">Average:</span>
                                    <span class="fuel-stat__value" id="avg-fuel">-</span>
                                </div>
                                <div class="fuel-stat">
                                    <span class="fuel-stat__label">Efficiency:</span>
                                    <span class="fuel-stat__value" id="fuel-efficiency">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Maintenance Overview -->
                    <div class="dashboard-card">
                        <div class="dashboard-card__header">
                            <div class="dashboard-card__title">
                                <i class="material-icons dashboard-card__icon dashboard-card__icon--info">build</i>
                                Maintenance Overview
                            </div>
                        </div>
                        <div class="dashboard-card__content">
                            <div class="maintenance-stats">
                                <div class="maintenance-stat">
                                    <span class="maintenance-stat__label">Scheduled:</span>
                                    <span class="maintenance-stat__value" id="scheduled-maintenance">-</span>
                                </div>
                                <div class="maintenance-stat">
                                    <span class="maintenance-stat__label">Overdue:</span>
                                    <span class="maintenance-stat__value" id="overdue-maintenance">-</span>
                                </div>
                                <div class="maintenance-stat">
                                    <span class="maintenance-stat__label">Critical:</span>
                                    <span class="maintenance-stat__value" id="critical-maintenance">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Predictions -->
                    <div class="dashboard-card">
                        <div class="dashboard-card__header">
                            <div class="dashboard-card__title">
                                <i class="material-icons dashboard-card__icon dashboard-card__icon--success">psychology</i>
                                AI Predictions
                            </div>
                        </div>
                        <div class="dashboard-card__content">
                            <div class="ai-predictions">
                                <div class="prediction-item">
                                    <div class="prediction-item__icon">
                                        <i class="material-icons">schedule</i>
                                    </div>
                                    <div class="prediction-item__content">
                                        <div class="prediction-item__title">Next Maintenance</div>
                                        <div class="prediction-item__value" id="next-maintenance">-</div>
                                    </div>
                                </div>
                                <div class="prediction-item">
                                    <div class="prediction-item__icon">
                                        <i class="material-icons">trending_up</i>
                                    </div>
                                    <div class="prediction-item__content">
                                        <div class="prediction-item__title">Efficiency Trend</div>
                                        <div class="prediction-item__value" id="efficiency-trend">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Trips -->
                <div class="dashboard-card mt-4">
                    <div class="dashboard-card__header">
                        <div class="dashboard-card__title">
                            <i class="material-icons dashboard-card__icon dashboard-card__icon--info">timeline</i>
                            Recent Trips
                        </div>
                    </div>
                    <div class="dashboard-card__content">
                        <div class="trips-list" id="recent-trips">
                            <div class="trip-item">
                                <div class="trip-item__icon">
                                    <i class="material-icons">info</i>
                                </div>
                                <div class="trip-item__content">
                                    <div class="trip-item__title">Loading trips...</div>
                                    <div class="trip-item__details">Please wait</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Locations Map -->
                <div class="dashboard-card mt-4">
                    <div class="dashboard-card__header">
                        <div class="dashboard-card__title">
                            <i class="material-icons dashboard-card__icon dashboard-card__icon--info">location_on</i>
                            Vehicle Locations
                        </div>
                    </div>
                    <div class="dashboard-card__content">
                        <div id="map" style="height: 400px; width: 100%; border-radius: 8px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                            <div class="map-placeholder">
                                <i class="material-icons" style="font-size: 48px; color: #ccc;">map</i>
                                <p>Map loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notifications Panel -->
    <div class="mdc-menu-surface--anchor">
        <div class="mdc-menu mdc-menu-surface" id="notifications-menu">
            <div class="notifications-header">
                <h6>Notifications</h6>
                <button class="mdc-icon-button material-icons" id="clear-notifications">
                    clear_all
                </button>
            </div>
            <ul class="mdc-list" role="menu" aria-hidden="true" aria-orientation="vertical" tabindex="-1" id="notifications-list">
                <!-- Notifications will be populated here -->
            </ul>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="mdc-circular-progress" style="width: 48px; height: 48px;" role="progressbar" aria-label="Loading">
            <div class="mdc-circular-progress__determinate-container">
                <svg class="mdc-circular-progress__determinate-circle-graphic" viewBox="0 0 48 48">
                    <circle class="mdc-circular-progress__determinate-track" cx="24" cy="24" r="18" stroke-width="4"/>
                    <circle class="mdc-circular-progress__determinate-circle" cx="24" cy="24" r="18" stroke-width="4"/>
                </svg>
            </div>
            <div class="mdc-circular-progress__indeterminate-container">
                <div class="mdc-circular-progress__spinner-layer">
                    <div class="mdc-circular-progress__circle-clipper mdc-circular-progress__circle-left">
                        <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48">
                            <circle cx="24" cy="24" r="18" stroke-width="4"/>
                        </svg>
                    </div>
                    <div class="mdc-circular-progress__gap-patch">
                        <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48">
                            <circle cx="24" cy="24" r="18" stroke-width="4"/>
                        </svg>
                    </div>
                    <div class="mdc-circular-progress__circle-clipper mdc-circular-progress__circle-right">
                        <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48">
                            <circle cx="24" cy="24" r="18" stroke-width="4"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Material Design Components JS -->
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

    <!-- Custom JS -->
    <script src="/js/main.js"></script>
    <script src="/js/map.js"></script>
    
    <script>
        // Initialize Material Design Components
        mdc.autoInit();
        
        // Initialize Socket.IO
        const socket = io();
        
        // Join user room if logged in
        <% if (typeof user !== 'undefined' && user) { %>
            socket.emit('join', '<%= user._id %>');
        <% } %>
        
        // Handle real-time updates
        socket.on('vehicleLocationUpdate', (data) => {
            // Update vehicle location on map
            if (window.updateVehicleLocation) {
                window.updateVehicleLocation(data);
            }
        });
        
        socket.on('maintenanceAlert', (data) => {
            // Show maintenance alert notification
            showNotification(data.message, 'warning');
        });

        // Dashboard data loading
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
        });

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard/data');
                const data = await response.json();
                
                // Update stats
                document.getElementById('total-vehicles').textContent = data.fleet.total;
                document.getElementById('active-vehicles').textContent = data.fleet.active;
                document.getElementById('maintenance-alerts').textContent = data.maintenance.overdue + data.maintenance.critical;
                document.getElementById('active-trips').textContent = data.trips.active;
                
                // Update health score
                const healthScore = Math.round(data.performance.averageHealthScore || 0);
                document.getElementById('fleet-health-score').textContent = healthScore + '%';
                document.getElementById('health-progress').style.width = healthScore + '%';
                
                // Update fuel stats
                document.getElementById('total-fuel').textContent = (data.fuel.totalFuelConsumed || 0).toFixed(1) + ' L';
                document.getElementById('avg-fuel').textContent = (data.fuel.averageConsumption || 0).toFixed(1) + ' L/100km';
                
                // Update maintenance stats
                document.getElementById('scheduled-maintenance').textContent = data.maintenance.scheduled || 0;
                document.getElementById('overdue-maintenance').textContent = data.maintenance.overdue || 0;
                document.getElementById('critical-maintenance').textContent = data.maintenance.critical || 0;
                
                // Update AI predictions
                if (data.aiPredictions && data.aiPredictions.length > 0) {
                    const nextMaintenance = data.aiPredictions[0];
                    document.getElementById('next-maintenance').textContent = nextMaintenance.vehicle + ' - ' + nextMaintenance.predictedDate;
                }
                
                // Update recent trips
                updateRecentTrips(data.recentTrips || []);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateRecentTrips(trips) {
            const tripsContainer = document.getElementById('recent-trips');
            
            if (trips.length === 0) {
                tripsContainer.innerHTML = `
                    <div class="trip-item">
                        <div class="trip-item__icon">
                            <i class="material-icons">info</i>
                        </div>
                        <div class="trip-item__content">
                            <div class="trip-item__title">No recent trips</div>
                            <div class="trip-item__details">No trips have been completed recently</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            tripsContainer.innerHTML = trips.map(trip => `
                <div class="trip-item">
                    <div class="trip-item__icon">
                        <i class="material-icons">navigation</i>
                    </div>
                    <div class="trip-item__content">
                        <div class="trip-item__title">${trip.vehicle?.make || 'Unknown'} ${trip.vehicle?.model || 'Vehicle'}</div>
                        <div class="trip-item__details">${trip.actualDistance || 0} km â€¢ ${trip.status || 'Unknown'}</div>
                    </div>
                </div>
            `).join('');
        }

        function refreshDashboard() {
            loadDashboardData();
            showNotification('Dashboard refreshed', 'success');
        }
    </script>
</body>
</html>